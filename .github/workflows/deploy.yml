name: Google API Check & Deploy

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install clasp
        run: npm install -g @google/clasp

      - name: Create Credentials (Hardcoded Mode)
        env:
          REFRESH_TOKEN: ${{ secrets.CLASPRC_JSON }}
          CLIENT_ID: "1072944905499-vm2v2i5dvn0a0d2o4ca36i1vge8cvbn0.apps.googleusercontent.com"
          CLIENT_SECRET: "v6V3fKV_zWU7iw1DrpO1rknX"
        run: |
          node -e '
          const fs = require("fs");
          const path = require("path");
          const os = require("os");
          const credentials = {
            tokens: {
              default: {
                client_id: process.env.CLIENT_ID,
                client_secret: process.env.CLIENT_SECRET,
                refresh_token: process.env.REFRESH_TOKEN,
                access_token: "dummy",
                expiry_date: 1,
                type: "authorized_user"
              }
            }
          };
          fs.writeFileSync(path.join(os.homedir(), ".clasprc.json"), JSON.stringify(credentials));
          '
          echo "LOG: Credentials file generated via Node.js"
          clasp login --status

      - name: Push to Apps Script
        run: clasp push --force

      - name: Deploy Version
        run: clasp deploy --description "Final Attempt after API check"
